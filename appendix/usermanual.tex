\chapter{Usermanual}
\label{chap:Usermanual}
The \entool{} is a diagnosis application for the continuous monitoring of \acs{IPSec} \acs{VPN} tunnels. It has two main features. Firstly it's capable of passively detecting packet loss occurring within the \acs{IPSec} tunnels. If the packet loss exceeds a specified threshold a Syslog warning is automatically dispatched. Secondly the \entool{} can actively determine the exact \acs{MTU} within a tunnel. This is useful when you're dealing with badly configured routers that block regular \acs{ICMP} messages outside of the tunnel. The \entool{} is designed to run as a daemon/service, but for testing purposes it also has a interactive mode.

\section{Installation Guide}
This chapter explains how to compile \& install the \entool{}.

\subsection{System Requirements}
The \entool{} is currently set up to run on Linux based systems and it requires a installation of the libpcap0.8-dev package. Depending on your local settings you may need to run the \entool{} as superuser (sudo) to be able to capture packets.

Although the \entool{} has only been tested on Linux based systems you may be able to get it running on OS X or windows without or with very few changes to its source code. The application was designed with a broad compatibility in mind.

While capturing 300mbit/s of packet-data the tool requires about 20\% CPU Usage on a modern Intel Xeon processor. So make sure to have enough spare processing power on your VPN routers.

\todo{CPU and RAM performance impact requirements überprüfen / mit aktuellen Daten ergänzen.}

\section{Installation}
To install the \entool{} you need to run the following bash script. It will take care of setting up a tempoary go-environment and getting the proper dependencies. You can also get the latest version of the build-script from the Github-Repository (\url{https://github.com/ipsecdiagtool/ipsecdiagtool/blob/master/build.sh}).

\lstset{language=bash, breaklines=true}
\begin{lstlisting}
#!/usr/bin/env bash
# Title:  build.sh                                       
# URL:    https://github.com/IPSecDiagTool/IPSecDiagTool
# Author: Jan Balmer, Theo Winter
#    
# This script can be used to build IPSecDiagTool in a
# Linux environment. Tested on Ubuntu 14.04.1 LTS.
#
# Dependencies:
#  - libpcap0.8-dev

echo "Cleaning workspace"
if [ -d go ]; then
	rm -rf go1.4.2.linux-amd64.tar.gz
	rm -rf go
    rm -rf workspace
fi

echo "Debug Infos"
go version
go env

echo "Setting up Go"
wget https://storage.googleapis.com/golang
/go1.4.2.linux-amd64.tar.gz
tar xf go1.4.2.linux-amd64.tar.gz
mkdir workspace

export GOROOT=$(pwd)/go
export GOPATH=$(pwd)/workspace
export PATH="$PATH:$GOROOT/bin:$GOPATH/bin"

cd workspace

#Can be deactivated if libpcap is already installed.
echo "Downloading dependencies"
sudo apt-get install libpcap0.8-dev

echo "Getting and building ipsecdiagtool"
go get github.com/ipsecdiagtool/ipsecdiagtool
\end{lstlisting}


\section{Usage}
This chapter explains how to use the \entool{}.

\subsection{Commands}
The \entool{} can be run either as a local application or in daemon mode. The following commands can be used to control the \entool{} when it is launched as a local application. After this table you will find specific information and examples for typical use cases.

\begin{tabularx}{\textwidth}{l|l|>{\raggedright\arraybackslash}X} 
\textbf{Command} & \textbf{Alternative} & \textbf{Explanation} \\
\hline
install &  & Install the \entool{} as a daemon.\\
uninstall & remove & Remove the \entool{}'s daemon.\\
i mtu &  & Run the mtu discovery in the interactive mode. The daemon does not need to be installed for this mode.\\
i pl [path ]&  & Run the packet loss detection in the interactive mode. The daemon does not need to be installed for this mode. The last argument is optional. You can specify a pcap file for testing purposes, or leave it blank and the network interface specified in the configuration will be used.\\
mtu [srcIP] [dstIP] & mtu-discovery & Tell a running daemon to start detecting the MTU for all configured tunnels. The \entool{} accepts a optional source and destination ip if you want to target a daemon running on a remote computer. \\
debug &  & Show the path to the configuration file, the applicationID and other information useful for debugging.\\
about & version & Display general information about the \entool{}. \\
help & & A list of commands and examples on how to use them.
\end{tabularx}

\subsection{Daemon Installation}
To install the \entool{} as a daemon you need to launch it as superuser via \code{ipsecdiagtool install}. Then a list of potentially supported init-systems for your operating system is displayed. For the Linux operating system you are typically given the options in the listing below.

\begin{lstlisting}[language=bash, caption=Supported linux init-systems]
Please choose one of the following init-systems:
  0. linux-systemd
  1. linux-upstart
  2. unix-systemv
Enter the number of the service you wish to install
\end{lstlisting}

If you are using Ubuntu, choose \code{linux-upstart}, otherwise go with \code{unix-systemv}. Please be aware that \code{linux-systemd},\code{darwin-launchd} and \code{windows-service} have not been tested as part of this thesis but they should potentially work just as well.

It is not recommended to install the \entool{} with multiple init-systems at the same time.

\subsection{Daemon Uninstall}
To uninstall the daemon of \entool{} you should first stop the tool via \code{service ipsecdiagtool stop}. Now you can run \code{ipsecdiagtool uninstall} as superuser and then choose the daemon you wish to remove. You will get a message whether or not the removal was successful. Alternatvely you can go to the location where the daemon init scripts are stored on your operating system and manually remove it. On Ubuntu this is \code{/etc/init.d/} for \code{linux-systemv} or \code{/etc/init/} for \code{linux-upstart}.

\subsection{Daemon Control}
A successfully installed daemon can be controlled via the following simple commands:

\begin{enumerate}
  \item \code{service ipsecdiagtool start}: Start the daemon.
  \item \code{service ipsecdiagtool status}: Shows whether the daemon is running or not.
  \item \code{service ipsecdiagtool stop}: Stops the daemon.
\end{enumerate}

\subsection{Daemon MTU Discovery}
To launch a \acs{MTU} discovery process on the daemon you need to run the local application via \code{ipsecdiagtool mtu}. If you want to start the \acs{MTU} discovery process on a remote machine you can do so by specifying an optional source and destination ip address. For example \code{ipsecdiagtool mtu 192.168.0.10 192.168.0.11} would launch a mtu discovery process on the remote machine \code{192.168.0.11}.

It is not advisable to start a mtu discovery process multiple times without waiting for a running process to finish. The application will not crash but the result of the \acs{MTU} discovery may not be valid.

Whenever a \acs{MTU} discovery process is started a message is sent to the syslog server specified in the configuration. Another message containing the result is sent when the discovery process is finished.

\subsection{Daemon Packet Loss Detection}
There are no additional steps involved to detect packet loss. Whenever the daemon is running, it is automatically detecting packet loss. The results of the packet loss detection are sent to the syslog server specified in the configuration and also written to a file located at \code{/var/log/}.
\todo{Jan: check if correct location}

